version: '3.8'

services:
  # ============ DATABASE ============
  # NOTE: For production, use the K8s Postgres instead of this container
  # This is kept for local Docker Compose development only
  postgres:
    image: postgres:15-alpine
    container_name: blockchain-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-blockchain_db}
      POSTGRES_USER: ${POSTGRES_USER:-blockchain_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change-me-to-secure-password}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - blockchain-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-blockchain_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============ BACKEND API ============
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: blockchain-backend
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-blockchain_user}:${POSTGRES_PASSWORD:-change-me-to-secure-password}@postgres:5432/${POSTGRES_DB:-blockchain_db}
      RPC_URL: ${RPC_URL:-https://ethereum.publicnode.com}
      FLASK_ENV: production
      FLASK_APP: api/ai_dashboard.py
      PYTHONUNBUFFERED: "1"
    ports:
      - "5000:5000"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - blockchain-network
    volumes:
      - ../src/backend:/app/src/backend  # Hot reload for development
      - models_cache:/app/models
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============ FRONTEND ============
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: blockchain-frontend
    environment:
      REACT_APP_API_URL: http://localhost:5000
      NODE_ENV: production
    ports:
      - "3000:3000"
    depends_on:
      - backend
    networks:
      - blockchain-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============ ML WORKER (Real-time) ============
  ml_worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.worker
    container_name: blockchain-ml-worker
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-blockchain_user}:${POSTGRES_PASSWORD:-change-me-to-secure-password}@postgres:5432/${POSTGRES_DB:-blockchain_db}
      RPC_URL: ${RPC_URL:-https://ethereum.publicnode.com}
      WORKER_MODE: realtime
      PYTHONUNBUFFERED: "1"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - blockchain-network
    volumes:
      - models_cache:/app/models
    restart: unless-stopped

  # ============ SCHEDULER (ETL/Batch) ============
  scheduler:
    build:
      context: ..
      dockerfile: docker/Dockerfile.scheduler
    container_name: blockchain-scheduler
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-blockchain_user}:${POSTGRES_PASSWORD:-change-me-to-secure-password}@postgres:5432/${POSTGRES_DB:-blockchain_db}
      RPC_URL: ${RPC_URL:-https://ethereum.publicnode.com}
      ETL_SCHEDULE_HOUR: ${ETL_SCHEDULE_HOUR:-0}
      ETL_SCHEDULE_MINUTE: ${ETL_SCHEDULE_MINUTE:-0}
      PYTHONUNBUFFERED: "1"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - blockchain-network
    volumes:
      - models_cache:/app/models
    restart: unless-stopped

  # ============ ANKR STREAMING SERVICE (Optional/Independent) ============
  # Separate service for real-time Ankr streaming
  # Runs independently without affecting batch processing
  ankr-streamer:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: blockchain-ankr-streamer
    command: python -c "from etl.stream_service import AnkrStreamingService; service = AnkrStreamingService(); service.run()"
    environment:
      ANKR_RPC_URL: ${ANKR_RPC_URL:-https://rpc.ankr.com/eth}
      ANKR_POLLING_INTERVAL: ${ANKR_POLLING_INTERVAL:-12}
      ANKR_BATCH_SIZE: ${ANKR_BATCH_SIZE:-10}
      STREAMING_ENABLED: ${STREAMING_ENABLED:-true}
      DATABASE_URL: postgresql://${POSTGRES_USER:-blockchain_user}:${POSTGRES_PASSWORD:-change-me-to-secure-password}@postgres:5432/${POSTGRES_DB:-blockchain_db}
      PYTHONUNBUFFERED: "1"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - blockchain-network
    volumes:
      - models_cache:/app/models
    restart: unless-stopped
    profiles:
      - streaming  # Optional service - activate with: docker-compose --profile streaming up

volumes:
  postgres_data:
    driver: local
  models_cache:
    driver: local

networks:
  blockchain-network:
    driver: bridge